<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grocery List Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .checked { opacity: 0.2; filter: grayscale(100%); }
        .active-tab { background: #6366f1 !important; color: white !important; }
        .selected-tag { background: #6366f1 !important; color: white !important; }
        button, input, label { min-height: 44px; touch-action: manipulation; }
        #store-nav::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-100 pb-20">

    <div class="sticky top-0 bg-white border-b z-50 flex overflow-x-auto p-2 gap-2" id="store-nav">
        <button onclick="setTab('All')" class="tab-btn active-tab px-4 py-2 rounded border text-xs font-bold">All</button>
        <button onclick="setTab('Costco')" class="tab-btn px-4 py-2 rounded border text-xs font-bold bg-gray-50">Costco</button>
        <button onclick="setTab('Whole Foods')" class="tab-btn px-4 py-2 rounded border text-xs font-bold bg-gray-50">Whole Foods</button>
        <button onclick="setTab('Trader Joe\'s')" class="tab-btn px-4 py-2 rounded border text-xs font-bold bg-gray-50">Trader Joe's</button>
    </div>

    <div class="p-4">
        <div class="bg-white p-4 rounded-xl shadow-sm mb-6 border">
            <div class="flex gap-3 mb-4">
                <label class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center relative overflow-hidden border">
                    <input type="file" id="pic" accept="image/*" class="hidden" onchange="preview(this)">
                    <img id="pre" class="hidden absolute inset-0 w-full h-full object-cover">
                    <span id="plus" class="text-2xl text-gray-400">+</span>
                </label>
                <input type="text" id="name" placeholder="Item Name" class="flex-1 p-2 border rounded">
            </div>
            
            <div class="flex gap-1 mb-4">
                <button onclick="tag(this)" class="tag border px-3 py-1 rounded-full text-[10px] font-bold">Costco</button>
                <button onclick="tag(this)" class="tag border px-3 py-1 rounded-full text-[10px] font-bold">Whole Foods</button>
                <button onclick="tag(this)" class="tag border px-3 py-1 rounded-full text-[10px] font-bold">Trader Joe's</button>
            </div>
            
            <button onclick="save()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded">Save to Library</button>
        </div>

        <div class="grid grid-cols-2 gap-3" id="list"></div>
    </div>

    <script>
        // Updated DB name to clear out the old "heavy" items
        let db = JSON.parse(localStorage.getItem('Groceries_V13_Unlimited')) || [];
        let currentTab = 'All';
        let activeTags = [];
        let imgData = null;

        function tag(btn) {
            const t = btn.innerText;
            if (activeTags.includes(t)) {
                activeTags = activeTags.filter(x => x !== t);
                btn.classList.remove('selected-tag');
            } else {
                activeTags.push(t);
                btn.classList.add('selected-tag');
            }
        }

        // The Resizer Logic: Compresses images to fit more in storage
        function preview(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 300; 
                        const scale = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        imgData = canvas.toDataURL('image/jpeg', 0.6); // 60% quality is perfect for icons
                        
                        document.getElementById('pre').src = imgData;
                        document.getElementById('pre').classList.remove('hidden');
                        document.getElementById('plus').classList.add('hidden');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function save() {
            const n = document.getElementById('name').value;
            if (!n || activeTags.length === 0) return alert("Add name and store");
            db.unshift({ id: Date.now(), name: n, stores: [...activeTags], img: imgData, needed: true });
            try {
                localStorage.setItem('Groceries_V13_Unlimited', JSON.stringify(db));
                location.reload(); 
            } catch (e) {
                alert("Storage full! Please delete some items.");
            }
        }

        function toggle(id) {
            const i = db.find(x => x.id === id);
            i.needed = !i.needed;
            localStorage.setItem('Groceries_V13_Unlimited', JSON.stringify(db));
            render();
        }

        function setTab(t) {
            currentTab = t;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active-tab', b.innerText === t));
            render();
        }

        function render() {
            const grid = document.getElementById('list');
            let filtered = db;
            if (currentTab !== 'All') {
                filtered = db.filter(i => i.stores.includes(currentTab) && i.needed);
            }
            grid.innerHTML = filtered.map(i => `
                <div class="bg-white rounded border relative ${!i.needed && currentTab === 'All' ? 'checked' : ''}">
                    <img src="${i.img || 'https://placehold.co/100'}" class="w-full h-24 object-cover" onclick="toggle(${i.id})">
                    <div class="p-2">
                        <p class="text-[10px] font-bold uppercase truncate">${i.name}</p>
                        <p class="text-[8px] text-gray-400">${i.stores.join(', ')}</p>
                        <button onclick="if(confirm('Delete?')){db=db.filter(x=>x.id!=${i.id});localStorage.setItem('Groceries_V13_Unlimited',JSON.stringify(db));render();}" class="text-[8px] text-red-500 mt-1">DELETE</button>
                    </div>
                </div>
            `).join('');
        }
        render();
    </script>
</body>
</html>
